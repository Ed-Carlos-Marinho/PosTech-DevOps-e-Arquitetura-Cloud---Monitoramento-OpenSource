# =============================================================================
# DOCKER COMPOSE - COMPLETE OBSERVABILITY STACK
# =============================================================================
# Este arquivo configura uma stack completa de observabilidade com Grafana,
# Prometheus, Loki, Promtail e Jaeger para a Aula 05 do curso PosTech DevOps
# Foco: Observabilidade completa com métricas, logs e traces distribuídos
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # GRAFANA - Plataforma de visualização unificada (logs + métricas + traces)
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    
    # Porta de acesso à interface web do Grafana
    ports:
      - "3000:3000"
    
    # Variáveis de ambiente para configuração inicial
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123     # Senha do admin (ALTERAR EM PRODUÇÃO)
      - GF_USERS_ALLOW_SIGN_UP=false            # Desabilita auto-registro
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor,correlations # Habilita editor TraceQL e correlações
    
    # Volumes para dados persistentes e configurações
    volumes:
      - grafana-data:/var/lib/grafana            # Dados persistentes do Grafana
      - grafana-config:/etc/grafana              # Configurações personalizadas
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Aguarda outros serviços estarem prontos
    depends_on:
      - prometheus
      - loki
      - jaeger-query

  # ---------------------------------------------------------------------------
  # PROMETHEUS SERVER - Coleta e armazenamento de métricas
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    
    # Porta de acesso à interface web do Prometheus
    ports:
      - "9090:9090"
    
    # Volumes para configuração e dados persistentes
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml           # Configuração principal
      - prometheus-data:/prometheus                               # Dados persistentes
    
    # Parâmetros de inicialização do Prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'           # Arquivo de configuração
      - '--storage.tsdb.path=/prometheus'                        # Caminho dos dados
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'                     # Retenção de dados: 200 horas
      - '--web.enable-lifecycle'                                 # Permite reload via API
      - '--web.enable-admin-api'                                 # Habilita API administrativa
    
    networks:
      - monitoring
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # LOKI - Sistema de agregação de logs
  # ---------------------------------------------------------------------------
  loki:
    image: grafana/loki:latest
    container_name: loki
    
    # Porta de acesso à API do Loki
    ports:
      - "3100:3100"
    
    # Volumes para configuração e dados persistentes
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yaml    # Configuração do Loki
      - loki-data:/loki                                   # Dados persistentes dos logs
    
    # Parâmetros de inicialização do Loki
    command: -config.file=/etc/loki/local-config.yaml
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Healthcheck para garantir que Loki está pronto
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # PROMTAIL - Agente de coleta de logs para Loki
  # ---------------------------------------------------------------------------
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    
    # Volumes para configuração e acesso aos logs
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml   # Configuração do Promtail
      - /var/log:/var/log:ro                             # Logs do sistema (somente leitura)
      - /var/lib/docker/containers:/var/lib/docker/containers:ro  # Logs dos containers
      - promtail-positions:/tmp/positions                # Posições de leitura dos arquivos
    
    # Parâmetros de inicialização do Promtail
    command: -config.file=/etc/promtail/config.yml
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Aguarda Loki estar saudável antes de iniciar
    depends_on:
      loki:
        condition: service_healthy

  # ---------------------------------------------------------------------------
  # JAEGER COLLECTOR - Recebe traces dos agentes e aplicações
  # ---------------------------------------------------------------------------
  jaeger-collector:
    image: jaegertracing/jaeger-collector:latest
    container_name: jaeger-collector
    
    # Portas para recebimento de traces
    ports:
      - "14268:14268"     # HTTP endpoint para spans
      - "14250:14250"     # gRPC endpoint para spans
      - "9411:9411"       # Zipkin compatible endpoint
    
    # Variáveis de ambiente para configuração
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch:9200
      - ES_TAGS_AS_FIELDS_ALL=true
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Aguarda Elasticsearch estar pronto
    depends_on:
      - elasticsearch

  # ---------------------------------------------------------------------------
  # JAEGER QUERY - Interface de consulta e API
  # ---------------------------------------------------------------------------
  jaeger-query:
    image: jaegertracing/jaeger-query:latest
    container_name: jaeger-query
    
    # Porta da interface web do Jaeger
    ports:
      - "16686:16686"     # Interface web do Jaeger UI
      - "16687:16687"     # gRPC endpoint
    
    # Variáveis de ambiente para configuração
    environment:
      - SPAN_STORAGE_TYPE=elasticsearch
      - ES_SERVER_URLS=http://elasticsearch:9200
      - ES_TAGS_AS_FIELDS_ALL=true
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Aguarda Elasticsearch estar pronto
    depends_on:
      - elasticsearch

  # ---------------------------------------------------------------------------
  # ELASTICSEARCH - Armazenamento de traces do Jaeger
  # ---------------------------------------------------------------------------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.0
    container_name: elasticsearch
    
    # Porta do Elasticsearch
    ports:
      - "9200:9200"
    
    # Variáveis de ambiente para configuração
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - xpack.security.enabled=false
    
    # Volumes para dados persistentes
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Healthcheck para garantir que Elasticsearch está pronto
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

# -----------------------------------------------------------------------------
# VOLUMES PERSISTENTES - Para manter dados entre reinicializações
# -----------------------------------------------------------------------------
volumes:
  grafana-data:         # Dados do Grafana (dashboards, usuários, configurações)
  grafana-config:       # Configurações personalizadas do Grafana
  prometheus-data:      # Dados do Prometheus (métricas, índices)
  loki-data:            # Dados do Loki (logs, índices, chunks)
  promtail-positions:   # Posições de leitura dos arquivos de log pelo Promtail
  elasticsearch-data:   # Dados do Elasticsearch (traces do Jaeger)

# -----------------------------------------------------------------------------
# REDES - Rede interna para comunicação entre serviços
# -----------------------------------------------------------------------------
networks:
  monitoring:
    driver: bridge

# =============================================================================
# INSTRUÇÕES DE USO - AULA 05:
# =============================================================================
# 1. Para iniciar a stack completa:
#    docker-compose -f docker-compose-observability.yml up -d
#
# 2. Para acessar as interfaces:
#    - Grafana: http://IP_SERVIDOR:3000 (admin/admin123)
#    - Prometheus: http://IP_SERVIDOR:9090
#    - Loki: http://IP_SERVIDOR:3100 (API - não tem interface web)
#    - Jaeger UI: http://IP_SERVIDOR:16686
#    - Elasticsearch: http://IP_SERVIDOR:9200
#
# 3. Configurar Data Sources no Grafana:
#    - Prometheus: http://prometheus:9090
#    - Loki: http://loki:3100
#    - Jaeger: http://jaeger-query:16686
#
# 4. Para ver logs:
#    docker-compose -f docker-compose-observability.yml logs -f [nome_do_serviço]
#
# 5. Para parar a stack:
#    docker-compose -f docker-compose-observability.yml down
# =============================================================================
#
# INTEGRAÇÃO GRAFANA + PROMETHEUS + LOKI + JAEGER:
# =============================================================================
# 1. Grafana como frontend unificado para métricas, logs e traces
# 2. Prometheus para métricas de aplicações e infraestrutura
# 3. Loki para logs centralizados com correlação por trace_id
# 4. Jaeger para tracing distribuído completo
# 5. Elasticsearch como backend de armazenamento para traces
# 6. Dashboards combinando os três pilares da observabilidade
# 7. Correlação temporal entre traces, logs e métricas
# 8. Foco educacional: observabilidade completa em microserviços
# =============================================================================