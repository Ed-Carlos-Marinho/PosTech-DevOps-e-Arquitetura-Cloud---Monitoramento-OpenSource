# =============================================================================
# DOCKER COMPOSE - JAEGER TRACING STACK
# =============================================================================
# Este arquivo configura stack de tracing distribuído com Jaeger e Grafana
# Aula 05 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Tracing distribuído para rastreamento de requisições entre serviços
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # GRAFANA - Plataforma de visualização de traces
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    
    # Porta de acesso à interface web do Grafana
    ports:
      - "3000:3000"
    
    # Variáveis de ambiente para configuração inicial
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123     # Senha do admin (ALTERAR EM PRODUÇÃO)
      - GF_USERS_ALLOW_SIGN_UP=false            # Desabilita auto-registro
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor # Habilita editor TraceQL
    
    # Volumes para dados persistentes e configurações
    volumes:
      - grafana-data:/var/lib/grafana            # Dados persistentes do Grafana
      - grafana-config:/etc/grafana              # Configurações personalizadas
    
    networks:
      - monitoring
    restart: unless-stopped
    
    # Aguarda Jaeger estar pronto
    depends_on:
      - jaeger

  # ---------------------------------------------------------------------------
  # JAEGER ALL-IN-ONE - Tracing distribuído completo (desenvolvimento)
  # ---------------------------------------------------------------------------
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    
    # Portas do Jaeger All-in-One
    ports:
      - "16686:16686"     # Interface web do Jaeger UI
      - "14268:14268"     # HTTP endpoint para spans
      - "14250:14250"     # gRPC endpoint para spans
      - "9411:9411"       # Zipkin compatible endpoint
      - "6831:6831/udp"   # UDP endpoint para spans (Jaeger Agent)
      - "6832:6832/udp"   # UDP endpoint para spans (Jaeger Agent)
      - "5778:5778"       # HTTP endpoint para configuração
    
    # Variáveis de ambiente para configuração
    environment:
      - COLLECTOR_ZIPKIN_HOST_PORT=:9411
      - COLLECTOR_OTLP_ENABLED=true
    
    networks:
      - monitoring
    restart: unless-stopped

# -----------------------------------------------------------------------------
# VOLUMES PERSISTENTES - Para manter dados entre reinicializações
# -----------------------------------------------------------------------------
volumes:
  grafana-data:         # Dados do Grafana (dashboards, usuários, configurações)
  grafana-config:       # Configurações personalizadas do Grafana

# -----------------------------------------------------------------------------
# REDES - Rede interna para comunicação entre serviços
# -----------------------------------------------------------------------------
networks:
  monitoring:
    driver: bridge

# =============================================================================
# INSTRUÇÕES DE USO - AULA 05:
# =============================================================================
# 1. Para iniciar a stack de tracing:
#    docker-compose -f docker-compose-observability.yml up -d
#
# 2. Para acessar as interfaces:
#    - Grafana: http://IP_SERVIDOR:3000 (admin/admin123)
#    - Jaeger UI: http://IP_SERVIDOR:16686
#
# 3. Configurar Data Source no Grafana:
#    - Jaeger: http://jaeger:16686
#
# 4. Para ver logs:
#    docker-compose -f docker-compose-observability.yml logs -f [nome_do_serviço]
#
# 5. Para parar a stack:
#    docker-compose -f docker-compose-observability.yml down
# =============================================================================
#
# TRACING DISTRIBUÍDO COM JAEGER:
# =============================================================================
# 1. Grafana como frontend para visualização de traces
# 2. Jaeger para tracing distribuído completo
# 3. Rastreamento de requisições entre múltiplos serviços
# 4. Identificação de gargalos e latências
# 5. Análise de dependências entre serviços
# 6. Foco educacional: tracing distribuído em microserviços
# =============================================================================