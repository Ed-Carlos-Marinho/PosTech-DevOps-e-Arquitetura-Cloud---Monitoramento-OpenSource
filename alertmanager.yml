# =============================================================================
# ALERTMANAGER CONFIGURATION - AULA 03
# =============================================================================
# Configura√ß√£o do Alertmanager para integra√ß√£o com Grafana
# Aula 03 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Alertas visuais e notifica√ß√µes personalizadas
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURA√á√ïES GLOBAIS
# -----------------------------------------------------------------------------
global:
  # Configura√ß√£o SMTP para envio de emails (ajustar conforme seu provedor)
  smtp_smarthost: 'localhost:587'              # Servidor SMTP
  smtp_from: 'alertmanager@example.com'        # Email remetente
  # smtp_auth_username: 'user@example.com'     # Usu√°rio SMTP (descomente se necess√°rio)
  # smtp_auth_password: 'password'             # Senha SMTP (descomente se necess√°rio)

# -----------------------------------------------------------------------------
# ROTEAMENTO DE ALERTAS
# -----------------------------------------------------------------------------
route:
  group_by: ['alertname']           # Agrupa alertas pelo nome
  group_wait: 10s                   # Tempo de espera antes de enviar o primeiro alerta do grupo
  group_interval: 10s               # Tempo entre envios de alertas do mesmo grupo
  repeat_interval: 1h               # Intervalo para reenvio de alertas n√£o resolvidos
  receiver: 'web.hook'              # Receptor padr√£o para todos os alertas

# -----------------------------------------------------------------------------
# RECEPTORES DE ALERTAS
# -----------------------------------------------------------------------------
receivers:
  
  # ---------------------------------------------------------------------------
  # WEBHOOK RECEIVER (Integra√ß√£o com Grafana e outros sistemas)
  # ---------------------------------------------------------------------------
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://127.0.0.1:5001/'           # URL do webhook (ajustar conforme necess√°rio)
        send_resolved: true                     # Envia notifica√ß√£o quando alerta √© resolvido
        # Para integra√ß√£o com Grafana OnCall ou outras ferramentas:
        # - url: 'http://grafana:80/api/webhooks/alertmanager'
        # http_config:                          # Configura√ß√µes HTTP adicionais (se necess√°rio)
        #   basic_auth:
        #     username: 'webhook_user'
        #     password: 'webhook_password'
  
  # ---------------------------------------------------------------------------
  # EMAIL RECEIVER (Para notifica√ß√µes por email)
  # ---------------------------------------------------------------------------
  - name: 'email-notifications'
    email_configs:
      - to: 'admin@example.com'                 # Email destinat√°rio (AJUSTAR)
        # Corpo do email com template Go (compat√≠vel com Grafana)
        html: |
          <h2>üö® Alerta do Sistema de Monitoramento</h2>
          <p><strong>Origem:</strong> Prometheus + Alertmanager + Grafana</p>
          {{ range .Alerts }}
          <div style="border: 1px solid #ddd; padding: 10px; margin: 10px 0;">
            <h3 style="color: {{ if eq .Status "firing" }}red{{ else }}green{{ end }};">
              {{ .Annotations.summary }}
            </h3>
            <p><strong>Descri√ß√£o:</strong> {{ .Annotations.description }}</p>
            <p><strong>Inst√¢ncia:</strong> {{ .Labels.instance }}</p>
            <p><strong>Severidade:</strong> {{ .Labels.severity }}</p>
            <p><strong>Status:</strong> {{ .Status }}</p>
            <p><strong>Hor√°rio:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          </div>
          {{ end }}
          <hr>
          <p><em>Este alerta foi gerado automaticamente pelo sistema de monitoramento.</em></p>
          <p><strong>Acesse o Grafana:</strong> <a href="http://IP_GRAFANA:80">Dashboard de Monitoramento</a></p>

# -----------------------------------------------------------------------------
# REGRAS DE INIBI√á√ÉO
# -----------------------------------------------------------------------------
# Evita spam de alertas relacionados (ex: alerta cr√≠tico inibe warnings)
inhibit_rules:
  - source_match:
      severity: 'critical'              # Se h√° um alerta cr√≠tico...
    target_match:
      severity: 'warning'               # ...inibe alertas de warning...
    equal: ['alertname', 'dev', 'instance']  # ...para a mesma inst√¢ncia e alerta

# =============================================================================
# INTEGRA√á√ÉO COM GRAFANA - AULA 03:
# =============================================================================
# 1. Grafana pode ser configurado como receptor de alertas
# 2. Alertmanager pode enviar alertas para Grafana OnCall
# 3. Grafana pode mostrar status do Alertmanager em dashboards
# 4. Configura√ß√£o de Data Source no Grafana:
#    - Type: Alertmanager
#    - URL: http://alertmanager:9093
#
# DASHBOARDS RECOMENDADOS PARA GRAFANA:
# - Alertmanager Overview (ID: 9578)
# - Prometheus Alertmanager (ID: 9094)
# =============================================================================
#
# INSTRU√á√ïES DE CONFIGURA√á√ÉO:
# =============================================================================
# 1. Para usar email, configure:
#    - smtp_smarthost com seu servidor SMTP
#    - smtp_from com email v√°lido
#    - Descomente smtp_auth_* se precisar de autentica√ß√£o
#    - Ajuste o email em 'to' do receiver 'email-notifications'
#
# 2. Para integra√ß√£o com Grafana:
#    - Configure webhook para Grafana OnCall
#    - Adicione Alertmanager como Data Source no Grafana
#    - Importe dashboards de monitoramento de alertas
#
# 3. Para testar alertas:
#    - Acesse http://IP_ALERTMANAGER:9093
#    - Use a interface para criar silenciamentos
#    - Monitore alertas no Grafana
#
# 4. Para recarregar configura√ß√£o:
#    docker-compose restart alertmanager
# =============================================================================