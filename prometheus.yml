# =============================================================================
# PROMETHEUS CONFIGURATION - AULA 05
# =============================================================================
# Configuração do Prometheus para correlação com logs do Loki e traces do Jaeger
# Aula 05 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Métricas para correlação com logs centralizados e tracing distribuído
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES GLOBAIS
# -----------------------------------------------------------------------------
global:
  scrape_interval: 15s      # Intervalo padrão para coleta de métricas (15 segundos)
  evaluation_interval: 15s  # Intervalo para avaliação de regras (não usado nesta aula)

# -----------------------------------------------------------------------------
# CONFIGURAÇÃO DE COLETA DE MÉTRICAS (SCRAPE CONFIGS)
# -----------------------------------------------------------------------------
scrape_configs:
  
  # ---------------------------------------------------------------------------
  # JOB 1: PROMETHEUS (Auto-monitoramento)
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']    # O próprio Prometheus se monitora
    # Métricas disponíveis: prometheus_*, go_*, process_*
    # Útil para correlacionar com logs do próprio Prometheus
  
  # ---------------------------------------------------------------------------
  # JOB 2: LOKI (Métricas do servidor de logs)
  # ---------------------------------------------------------------------------
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']         # Métricas do Loki
    # Métricas disponíveis: loki_*, promtail_*
    # Útil para monitorar performance do sistema de logs
  
  # ---------------------------------------------------------------------------
  # JOB 3: PROMTAIL LOCAL (Métricas do agente de coleta)
  # ---------------------------------------------------------------------------
  - job_name: 'promtail-local'
    static_configs:
      - targets: ['promtail:9080']     # Promtail da própria instância
    # Métricas disponíveis: promtail_*
    # Útil para monitorar coleta de logs local

  # ---------------------------------------------------------------------------
  # JOB 4: JAEGER COLLECTOR (Métricas do coletor de traces)
  # ---------------------------------------------------------------------------
  - job_name: 'jaeger-collector'
    static_configs:
      - targets: ['jaeger-collector:14269']  # Métricas do Jaeger Collector
    # Métricas disponíveis: jaeger_collector_*
    # Útil para monitorar recebimento e processamento de traces

  # ---------------------------------------------------------------------------
  # JOB 5: JAEGER QUERY (Métricas da interface de consulta)
  # ---------------------------------------------------------------------------
  - job_name: 'jaeger-query'
    static_configs:
      - targets: ['jaeger-query:16687']      # Métricas do Jaeger Query
    # Métricas disponíveis: jaeger_query_*
    # Útil para monitorar consultas e performance da UI

  # ---------------------------------------------------------------------------
  # JOB 6: ELASTICSEARCH (Métricas do armazenamento de traces)
  # ---------------------------------------------------------------------------
  - job_name: 'elasticsearch'
    static_configs:
      - targets: ['elasticsearch:9200']     # Métricas do Elasticsearch
    metrics_path: '/_prometheus/metrics'
    # Métricas disponíveis: elasticsearch_*
    # Útil para monitorar armazenamento e indexação de traces

# =============================================================================
# INTEGRAÇÃO COM GRAFANA - AULA 05:
# =============================================================================
# 1. Este Prometheus será configurado como Data Source no Grafana
# 2. URL do Data Source: http://prometheus:9090
# 3. Foco principal: correlacionar métricas com logs do Loki e traces do Jaeger
#
# 4. Métricas principais para correlação:
#    - prometheus_tsdb_samples_appended_total: Volume de métricas
#    - loki_ingester_streams: Número de streams de logs
#    - promtail_sent_entries_total: Logs enviados pelo Promtail
#    - jaeger_collector_spans_received_total: Spans recebidos pelo Jaeger
#    - jaeger_query_requests_total: Consultas no Jaeger
#    - up: Status dos serviços (correlacionar com logs de erro e traces)
#
# 5. Dashboards recomendados:
#    - Loki Stack Monitoring (ID: 14055)
#    - Jaeger Monitoring (ID: 10001)
#    - Prometheus Stats (ID: 2)
# =============================================================================
#
# CORRELAÇÃO LOGS + MÉTRICAS + TRACES:
# =============================================================================
# Exemplos de correlação entre Prometheus, Loki e Jaeger:
#
# 1. Volume de dados por pilar:
#    - Prometheus: rate(promtail_sent_entries_total[5m])
#    - Loki: rate({job="frontend-service"}[5m])
#    - Jaeger: rate(jaeger_collector_spans_received_total[5m])
#
# 2. Erros correlacionados:
#    - Prometheus: up{job="loki"} == 0
#    - Loki: {level="error"} | json | trace_id!=""
#    - Jaeger: Traces com status error
#
# 3. Performance do sistema de observabilidade:
#    - Prometheus: jaeger_collector_queue_length
#    - Loki: {job="jaeger-logs"} |= "slow"
#    - Jaeger: Latência de consultas na UI
#
# 4. Correlação completa por trace_id:
#    - Prometheus: jaeger_query_requests_total{operation="find_traces"}
#    - Loki: {job=~"frontend-service|backend-service"} | json | trace_id="TRACE_ID"
#    - Jaeger: Trace específico com spans detalhados
# =============================================================================
#
# 2. Erros em logs vs status de serviços:
#    - Prometheus: up{job="loki"}
#    - Loki: {job="test-app",level="error"}
#
# 3. Performance do sistema de logs:
#    - Prometheus: loki_ingester_chunks_created_total
#    - Loki: {job="loki"} |= "error"
# =============================================================================