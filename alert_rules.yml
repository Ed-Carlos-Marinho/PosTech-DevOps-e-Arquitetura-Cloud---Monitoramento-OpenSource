# =============================================================================
# PROMETHEUS ALERT RULES - AULA 03
# =============================================================================
# Regras de alerta para integração com Grafana e visualização avançada
# Aula 03 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Alertas baseados em métricas para dashboards dinâmicos
# =============================================================================

groups:
  # ---------------------------------------------------------------------------
  # GRUPO: ALERTAS DE SISTEMA (Para dashboards Grafana)
  # ---------------------------------------------------------------------------
  - name: system_alerts
    rules:
      
      # -----------------------------------------------------------------------
      # ALERTA: USO ALTO DE CPU
      # -----------------------------------------------------------------------
      - alert: HighCPUUsage
        # Expressão PromQL: CPU usage > 80% por mais de 2 minutos
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 2m                                 # Duração antes de disparar o alerta
        labels:
          severity: warning                     # Nível de severidade
          dashboard: "node-exporter"            # Dashboard relacionado no Grafana
          panel: "cpu-usage"                    # Painel específico no dashboard
        annotations:
          summary: "High CPU usage detected"   # Resumo do alerta
          description: "CPU usage is above 80% for more than 2 minutes on {{ $labels.instance }}"
          # Links para Grafana (ajustar IP_GRAFANA)
          grafana_url: "http://IP_GRAFANA:80/d/node-exporter/node-exporter?var-instance={{ $labels.instance }}"
          runbook_url: "https://wiki.company.com/runbooks/high-cpu"
      
      # -----------------------------------------------------------------------
      # ALERTA: USO ALTO DE MEMÓRIA
      # -----------------------------------------------------------------------
      - alert: HighMemoryUsage
        # Expressão PromQL: Memory usage > 85% por mais de 2 minutos
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 2m                                 # Duração antes de disparar o alerta
        labels:
          severity: warning                     # Nível de severidade
          dashboard: "node-exporter"            # Dashboard relacionado no Grafana
          panel: "memory-usage"                 # Painel específico no dashboard
        annotations:
          summary: "High memory usage detected" # Resumo do alerta
          description: "Memory usage is above 85% for more than 2 minutes on {{ $labels.instance }}"
          # Links para Grafana
          grafana_url: "http://IP_GRAFANA:80/d/node-exporter/node-exporter?var-instance={{ $labels.instance }}"
          runbook_url: "https://wiki.company.com/runbooks/high-memory"
      
      # -----------------------------------------------------------------------
      # ALERTA: ESPAÇO EM DISCO BAIXO
      # -----------------------------------------------------------------------
      - alert: DiskSpaceLow
        # Expressão PromQL: Disk space < 20% por mais de 1 minuto
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 1m                                 # Duração antes de disparar o alerta
        labels:
          severity: critical                    # Nível de severidade CRÍTICO
          dashboard: "node-exporter"            # Dashboard relacionado no Grafana
          panel: "disk-usage"                   # Painel específico no dashboard
        annotations:
          summary: "Low disk space"             # Resumo do alerta
          description: "Disk space is below 20% on {{ $labels.instance }}"
          # Links para Grafana
          grafana_url: "http://IP_GRAFANA:80/d/node-exporter/node-exporter?var-instance={{ $labels.instance }}"
          runbook_url: "https://wiki.company.com/runbooks/disk-space"
      
      # -----------------------------------------------------------------------
      # ALERTA: SERVIÇO INDISPONÍVEL
      # -----------------------------------------------------------------------
      - alert: ServiceDown
        # Expressão PromQL: Target está down (up == 0)
        expr: up == 0
        for: 1m                                 # Duração antes de disparar o alerta
        labels:
          severity: critical                    # Nível de severidade CRÍTICO
          dashboard: "prometheus-targets"       # Dashboard relacionado no Grafana
          panel: "targets-status"               # Painel específico no dashboard
        annotations:
          summary: "Service is down"            # Resumo do alerta
          description: "{{ $labels.job }} service is down on {{ $labels.instance }}"
          # Links para Grafana
          grafana_url: "http://IP_GRAFANA:80/d/prometheus/prometheus-targets?var-job={{ $labels.job }}"
          runbook_url: "https://wiki.company.com/runbooks/service-down"

# =============================================================================
# INTEGRAÇÃO COM GRAFANA - AULA 03:
# =============================================================================
# 1. Estes alertas aparecerão automaticamente no Grafana quando:
#    - Prometheus for configurado como Data Source
#    - Alertmanager for configurado como Data Source
#
# 2. Dashboards recomendados para visualizar alertas:
#    - Prometheus Alerts (ID: 11098)
#    - Alertmanager Overview (ID: 9578)
#
# 3. Painéis Grafana podem usar estas métricas:
#    - ALERTS{alertname="HighCPUUsage"}: Status dos alertas
#    - ALERTS_FOR_STATE: Tempo que alerta está ativo
#    - prometheus_notifications_total: Notificações enviadas
#
# 4. Variáveis dinâmicas para dashboards:
#    - $instance: Filtra por instância específica
#    - $job: Filtra por job específico
#    - $severity: Filtra por nível de severidade
# =============================================================================
#
# EXPLICAÇÃO DAS EXPRESSÕES PROMQL:
# =============================================================================
#
# 1. CPU Usage:
#    - node_cpu_seconds_total{mode="idle"}: Tempo de CPU em modo idle
#    - irate(...[5m]): Taxa instantânea nos últimos 5 minutos
#    - 100 - (...* 100): Converte para porcentagem de uso (não idle)
#
# 2. Memory Usage:
#    - node_memory_MemTotal_bytes: Memória total
#    - node_memory_MemAvailable_bytes: Memória disponível
#    - Fórmula: (Total - Disponível) / Total * 100
#
# 3. Disk Space:
#    - node_filesystem_avail_bytes: Espaço disponível
#    - node_filesystem_size_bytes: Tamanho total do filesystem
#    - mountpoint="/": Foca no filesystem raiz
#
# 4. Service Status:
#    - up: Métrica automática do Prometheus (1=up, 0=down)
#
# =============================================================================
# LABELS ADICIONAIS PARA GRAFANA:
# =============================================================================
# - dashboard: Identifica qual dashboard Grafana usar
# - panel: Identifica qual painel específico no dashboard
# - grafana_url: Link direto para o dashboard relevante
# - runbook_url: Link para documentação de resolução
# =============================================================================
#
# PERSONALIZAÇÃO PARA DIFERENTES AMBIENTES:
# =============================================================================
# Para ajustar os thresholds, modifique os valores nas expressões:
# - CPU: Altere "> 80" para o valor desejado
# - Memory: Altere "> 85" para o valor desejado  
# - Disk: Altere "< 20" para o valor desejado
# - Timing: Altere "for: 2m" para a duração desejada
#
# Para adicionar novos alertas específicos do Grafana:
# - Inclua labels dashboard e panel
# - Adicione grafana_url com link direto
# - Use variáveis {{ $labels.instance }} nos links
# =============================================================================