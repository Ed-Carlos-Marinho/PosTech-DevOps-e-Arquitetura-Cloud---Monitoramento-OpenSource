# =============================================================================
# PROMETHEUS ALERT RULES
# =============================================================================
# Regras de alerta personalizadas para monitoramento de infraestrutura
# Aula 02 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# =============================================================================

groups:
  # ---------------------------------------------------------------------------
  # GRUPO: ALERTAS DE SISTEMA
  # ---------------------------------------------------------------------------
  - name: system_alerts
    rules:
      
      # -----------------------------------------------------------------------
      # ALERTA: USO ALTO DE CPU
      # -----------------------------------------------------------------------
      - alert: HighCPUUsage
        # Expressão PromQL: CPU usage > 80% por mais de 2 minutos
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 2m                                 # Duração antes de disparar o alerta
        labels:
          severity: warning                     # Nível de severidade
        annotations:
          summary: "High CPU usage detected"   # Resumo do alerta
          description: "CPU usage is above 80% for more than 2 minutes on {{ $labels.instance }}"
      
      # -----------------------------------------------------------------------
      # ALERTA: USO ALTO DE MEMÓRIA
      # -----------------------------------------------------------------------
      - alert: HighMemoryUsage
        # Expressão PromQL: Memory usage > 85% por mais de 2 minutos
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 2m                                 # Duração antes de disparar o alerta
        labels:
          severity: warning                     # Nível de severidade
        annotations:
          summary: "High memory usage detected" # Resumo do alerta
          description: "Memory usage is above 85% for more than 2 minutes on {{ $labels.instance }}"
      
      # -----------------------------------------------------------------------
      # ALERTA: ESPAÇO EM DISCO BAIXO
      # -----------------------------------------------------------------------
      - alert: DiskSpaceLow
        # Expressão PromQL: Disk space < 20% por mais de 1 minuto
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 20
        for: 1m                                 # Duração antes de disparar o alerta
        labels:
          severity: critical                    # Nível de severidade CRÍTICO
        annotations:
          summary: "Low disk space"             # Resumo do alerta
          description: "Disk space is below 20% on {{ $labels.instance }}"
      
      # -----------------------------------------------------------------------
      # ALERTA: SERVIÇO INDISPONÍVEL
      # -----------------------------------------------------------------------
      - alert: ServiceDown
        # Expressão PromQL: Target está down (up == 0)
        expr: up == 0
        for: 1m                                 # Duração antes de disparar o alerta
        labels:
          severity: critical                    # Nível de severidade CRÍTICO
        annotations:
          summary: "Service is down"            # Resumo do alerta
          description: "{{ $labels.job }} service is down on {{ $labels.instance }}"

# =============================================================================
# EXPLICAÇÃO DAS EXPRESSÕES PROMQL:
# =============================================================================
#
# 1. CPU Usage:
#    - node_cpu_seconds_total{mode="idle"}: Tempo de CPU em modo idle
#    - irate(...[5m]): Taxa instantânea nos últimos 5 minutos
#    - 100 - (...* 100): Converte para porcentagem de uso (não idle)
#
# 2. Memory Usage:
#    - node_memory_MemTotal_bytes: Memória total
#    - node_memory_MemAvailable_bytes: Memória disponível
#    - Fórmula: (Total - Disponível) / Total * 100
#
# 3. Disk Space:
#    - node_filesystem_avail_bytes: Espaço disponível
#    - node_filesystem_size_bytes: Tamanho total do filesystem
#    - mountpoint="/": Foca no filesystem raiz
#
# 4. Service Status:
#    - up: Métrica automática do Prometheus (1=up, 0=down)
#
# =============================================================================
# NÍVEIS DE SEVERIDADE:
# =============================================================================
# - warning: Situações que precisam de atenção mas não são críticas
# - critical: Situações que requerem ação imediata
# - info: Informações gerais (não usado neste exemplo)
# =============================================================================
#
# PERSONALIZAÇÃO:
# =============================================================================
# Para ajustar os thresholds, modifique os valores nas expressões:
# - CPU: Altere "> 80" para o valor desejado
# - Memory: Altere "> 85" para o valor desejado  
# - Disk: Altere "< 20" para o valor desejado
# - Timing: Altere "for: 2m" para a duração desejada
# =============================================================================