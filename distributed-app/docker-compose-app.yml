# =============================================================================
# DOCKER COMPOSE - DISTRIBUTED APPLICATIONS STACK
# =============================================================================
# Este arquivo configura aplicações distribuídas instrumentadas com tracing
# Aula 05 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Aplicações distribuídas com instrumentação OpenTelemetry para Jaeger
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # FRONTEND SERVICE - React/Node.js com instrumentação OpenTelemetry
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend-service
    
    # Porta de acesso externa
    ports:
      - "80:3000"
    
    # Variáveis de ambiente
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://backend:5000
      - JAEGER_AGENT_HOST=jaeger-agent
      - JAEGER_AGENT_PORT=6832
      - JAEGER_SERVICE_NAME=frontend-service
      - JAEGER_SAMPLER_TYPE=const
      - JAEGER_SAMPLER_PARAM=1
    
    # Volumes para logs
    volumes:
      - frontend-logs:/app/logs
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Aguarda backend estar disponível
    depends_on:
      - backend
      - jaeger-agent

  # ---------------------------------------------------------------------------
  # BACKEND SERVICE - Python Flask com instrumentação OpenTelemetry
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-service
    
    # Porta interna
    ports:
      - "5001:5000"
    
    # Variáveis de ambiente
    environment:
      - FLASK_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce
      - REDIS_URL=redis://redis:6379/0
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - JAEGER_AGENT_HOST=jaeger-agent
      - JAEGER_AGENT_PORT=6832
      - JAEGER_SERVICE_NAME=backend-service
      - JAEGER_SAMPLER_TYPE=const
      - JAEGER_SAMPLER_PARAM=1
    
    # Volumes para logs
    volumes:
      - backend-logs:/app/logs
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Aguarda dependências estarem disponíveis
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - jaeger-agent

  # ---------------------------------------------------------------------------
  # DATABASE SERVICE - PostgreSQL
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:13
    container_name: postgres-db
    
    # Porta do PostgreSQL
    ports:
      - "5432:5432"
    
    # Variáveis de ambiente
    environment:
      - POSTGRES_DB=ecommerce
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    
    # Volumes para dados persistentes
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # CACHE SERVICE - Redis
  # ---------------------------------------------------------------------------
  redis:
    image: redis:6-alpine
    container_name: redis-cache
    
    # Porta do Redis
    ports:
      - "6379:6379"
    
    # Volumes para dados persistentes
    volumes:
      - redis-data:/data
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # MESSAGE QUEUE - RabbitMQ
  # ---------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq-queue
    
    # Portas do RabbitMQ
    ports:
      - "5672:5672"       # AMQP port
      - "15672:15672"     # Management UI
    
    # Variáveis de ambiente
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    
    # Volumes para dados persistentes
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # JAEGER AGENT - Coleta traces localmente e envia para collector
  # ---------------------------------------------------------------------------
  jaeger-agent:
    image: jaegertracing/jaeger-agent:latest
    container_name: jaeger-agent
    
    # Portas para recebimento de traces
    ports:
      - "6831:6831/udp"   # Jaeger thrift compact
      - "6832:6832/udp"   # Jaeger thrift binary
      - "5778:5778"       # HTTP endpoint para configuração
      - "14271:14271"     # Admin port
    
    # Configuração do agente - SUBSTITUIR JAEGER_COLLECTOR_HOST pelo IP da instância 1
    environment:
      - REPORTER_GRPC_HOST_PORT=${JAEGER_COLLECTOR_HOST:-localhost}:14250
      - LOG_LEVEL=debug
    
    networks:
      - app-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # PROMTAIL - Coleta de logs para envio ao Loki
  # ---------------------------------------------------------------------------
  promtail:
    image: grafana/promtail:latest
    container_name: promtail-app
    
    # Porta para métricas do Promtail
    ports:
      - "9080:9080"
    
    # Volumes para configuração e acesso aos logs
    volumes:
      - ./promtail-app-config.yml:/etc/promtail/config.yml
      - frontend-logs:/app/logs/frontend:ro
      - backend-logs:/app/logs/backend:ro
      - /var/log:/var/log:ro
      - promtail-positions:/tmp/positions
    
    # Parâmetros de inicialização do Promtail
    command: -config.file=/etc/promtail/config.yml
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Aguarda outros serviços estarem prontos
    depends_on:
      - frontend
      - backend

# -----------------------------------------------------------------------------
# VOLUMES PERSISTENTES - Para manter dados entre reinicializações
# -----------------------------------------------------------------------------
volumes:
  postgres-data:        # Dados do PostgreSQL
  redis-data:           # Dados do Redis
  rabbitmq-data:        # Dados do RabbitMQ
  frontend-logs:        # Logs do frontend
  backend-logs:         # Logs do backend
  promtail-positions:   # Posições de leitura dos arquivos de log pelo Promtail

# -----------------------------------------------------------------------------
# REDES - Rede interna para comunicação entre serviços
# -----------------------------------------------------------------------------
networks:
  app-network:
    driver: bridge

# =============================================================================
# INSTRUÇÕES DE USO - INSTÂNCIA 2:
# =============================================================================
# 1. Para iniciar a stack de aplicações distribuídas:
#    docker-compose -f docker-compose-app.yml up -d
#
# 2. Para acessar as aplicações:
#    - Frontend: http://IP_INSTANCIA_2
#    - Backend API: http://IP_INSTANCIA_2:5000
#    - RabbitMQ Management: http://IP_INSTANCIA_2:15672 (guest/guest)
#    - Métricas Promtail: http://IP_INSTANCIA_2:9080/metrics
#
# 3. Para gerar traces de teste:
#    curl http://IP_INSTANCIA_2/api/users
#    curl http://IP_INSTANCIA_2/api/orders
#    curl http://IP_INSTANCIA_2/api/products
#
# 4. Para ver logs:
#    docker-compose -f docker-compose-app.yml logs -f frontend
#    docker-compose -f docker-compose-app.yml logs -f backend
#
# 5. Para parar a stack:
#    docker-compose -f docker-compose-app.yml down
# =============================================================================
#
# CONFIGURAÇÃO DO JAEGER AGENT:
# =============================================================================
# 1. Editar docker-compose-app.yml
# 2. Substituir JAEGER_COLLECTOR_IP pelo IP real da Instância 1
# 3. Reiniciar: docker-compose -f docker-compose-app.yml restart jaeger-agent
# =============================================================================