# =============================================================================
# DOCKER COMPOSE - DISTRIBUTED APPLICATIONS STACK
# =============================================================================
# Este arquivo configura aplica√ß√µes distribu√≠das instrumentadas com tracing
# Aula 05 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Aplica√ß√µes distribu√≠das com instrumenta√ß√£o OpenTelemetry para Jaeger
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # FRONTEND SERVICE - React/Node.js com instrumenta√ß√£o OpenTelemetry
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: frontend-service
    
    # Porta de acesso externa
    ports:
      - "80:3000"
    
    # Vari√°veis de ambiente
    environment:
      - NODE_ENV=production
      - BACKEND_URL=http://backend:5000
      - JAEGER_AGENT_HOST=jaeger-agent
      - JAEGER_AGENT_PORT=6832
      - JAEGER_SERVICE_NAME=frontend-service
      - JAEGER_SAMPLER_TYPE=const
      - JAEGER_SAMPLER_PARAM=1
    
    # Volumes para logs
    volumes:
      - frontend-logs:/app/logs
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Aguarda backend estar dispon√≠vel
    depends_on:
      - backend
      - jaeger-agent

  # ---------------------------------------------------------------------------
  # BACKEND SERVICE - Node.js/Express com instrumenta√ß√£o OpenTelemetry
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend-service
    
    # Porta interna
    ports:
      - "5001:5000"
    
    # Vari√°veis de ambiente
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce
      - REDIS_URL=redis://redis:6379/0
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - JAEGER_AGENT_HOST=jaeger-agent
      - JAEGER_AGENT_PORT=6832
      - JAEGER_SERVICE_NAME=backend-service
      - JAEGER_SAMPLER_TYPE=const
      - JAEGER_SAMPLER_PARAM=1
    
    # Volumes para logs
    volumes:
      - backend-logs:/app/logs
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Aguarda depend√™ncias estarem dispon√≠veis
    depends_on:
      - postgres
      - redis
      - rabbitmq
      - jaeger-agent

  # ---------------------------------------------------------------------------
  # DATABASE SERVICE - PostgreSQL
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:13
    container_name: postgres-db
    
    # Porta do PostgreSQL
    ports:
      - "5432:5432"
    
    # Vari√°veis de ambiente
    environment:
      - POSTGRES_DB=ecommerce
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    
    # Volumes para dados persistentes
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # CACHE SERVICE - Redis
  # ---------------------------------------------------------------------------
  redis:
    image: redis:6-alpine
    container_name: redis-cache
    
    # Porta do Redis
    ports:
      - "6379:6379"
    
    # Volumes para dados persistentes
    volumes:
      - redis-data:/data
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # MESSAGE QUEUE - RabbitMQ
  # ---------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq-queue
    
    # Portas do RabbitMQ
    ports:
      - "5672:5672"       # AMQP port
      - "15672:15672"     # Management UI
    
    # Vari√°veis de ambiente
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    
    # Volumes para dados persistentes
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ---------------------------------------------------------------------------
  # JAEGER AGENT - Coleta traces localmente e envia para collector
  # ---------------------------------------------------------------------------
  jaeger-agent:
    image: jaegertracing/jaeger-agent:latest
    container_name: jaeger-agent
    
    # Portas para recebimento de traces
    ports:
      - "6831:6831/udp"   # Jaeger thrift compact
      - "6832:6832/udp"   # Jaeger thrift binary
      - "5778:5778"       # HTTP endpoint para configura√ß√£o
      - "14271:14271"     # Admin port
    
    # Configura√ß√£o do agente - IP da inst√¢ncia 1 (Jaeger Collector)
    # IMPORTANTE: Substituir pelo IP privado real da inst√¢ncia de observabilidade
    environment:
      - REPORTER_GRPC_HOST_PORT=JAEGER_COLLECTOR_IP:14250
      - LOG_LEVEL=debug
    
    networks:
      - app-network
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # TRACE GENERATOR - Gera traces automaticamente para demonstra√ß√£o
  # ---------------------------------------------------------------------------
  trace-generator:
    image: curlimages/curl:latest
    container_name: trace-generator
    
    # Script que faz requisi√ß√µes peri√≥dicas
    command: >
      sh -c '
        echo "üöÄ Trace Generator iniciado - aguardando servi√ßos..."
        sleep 30
        echo "‚úÖ Iniciando gera√ß√£o de traces..."
        
        while true; do
          echo "üìä [$(date +%H:%M:%S)] Gerando traces..."
          
          # GET /api/users
          curl -s -o /dev/null -w "Users: %{http_code}\n" http://frontend:3000/api/users
          sleep 2
          
          # GET /api/products
          curl -s -o /dev/null -w "Products: %{http_code}\n" http://frontend:3000/api/products
          sleep 2
          
          # GET /api/orders
          curl -s -o /dev/null -w "Orders: %{http_code}\n" http://frontend:3000/api/orders
          sleep 3
          
          # POST /api/orders (criar pedido)
          curl -s -o /dev/null -w "Create Order: %{http_code}\n" \
            -X POST http://frontend:3000/api/orders \
            -H "Content-Type: application/json" \
            -d "{\"user_id\": $$((RANDOM % 10 + 1)), \"total_amount\": $$((RANDOM % 500 + 50))}"
          
          echo "‚è≥ Aguardando 15 segundos antes do pr√≥ximo ciclo..."
          sleep 15
        done
      '
    
    networks:
      - app-network
    restart: unless-stopped
    
    # Aguarda frontend estar dispon√≠vel
    depends_on:
      - frontend
      - backend

# -----------------------------------------------------------------------------
# VOLUMES PERSISTENTES - Para manter dados entre reinicializa√ß√µes
# -----------------------------------------------------------------------------
volumes:
  postgres-data:        # Dados do PostgreSQL
  redis-data:           # Dados do Redis
  rabbitmq-data:        # Dados do RabbitMQ
  frontend-logs:        # Logs do frontend
  backend-logs:         # Logs do backend

# -----------------------------------------------------------------------------
# REDES - Rede interna para comunica√ß√£o entre servi√ßos
# -----------------------------------------------------------------------------
networks:
  app-network:
    driver: bridge

# =============================================================================
# INSTRU√á√ïES DE USO - INST√ÇNCIA 2:
# =============================================================================
# 1. Para iniciar a stack de aplica√ß√µes distribu√≠das:
#    docker-compose -f docker-compose-app.yml up -d
#
# 2. Para acessar as aplica√ß√µes:
#    - Frontend: http://IP_INSTANCIA_2
#    - Backend API: http://IP_INSTANCIA_2:5000
#    - RabbitMQ Management: http://IP_INSTANCIA_2:15672 (guest/guest)
#    - Jaeger Agent Metrics: http://IP_INSTANCIA_2:5778/metrics
#
# 3. Gera√ß√£o autom√°tica de traces:
#    O servi√ßo trace-generator gera traces automaticamente a cada 15 segundos
#    Para ver logs: docker-compose -f docker-compose-app.yml logs -f trace-generator
#
# 4. Para gerar traces manualmente:
#    curl http://IP_INSTANCIA_2/api/users
#    curl http://IP_INSTANCIA_2/api/orders
#    curl http://IP_INSTANCIA_2/api/products
#
# 5. Para ver logs:
#    docker-compose -f docker-compose-app.yml logs -f frontend
#    docker-compose -f docker-compose-app.yml logs -f backend
#    docker-compose -f docker-compose-app.yml logs -f trace-generator
#
# 6. Para parar/iniciar o gerador de traces:
#    docker-compose -f docker-compose-app.yml stop trace-generator
#    docker-compose -f docker-compose-app.yml start trace-generator
#
# 7. Para parar a stack:
#    docker-compose -f docker-compose-app.yml down
# =============================================================================
#
# CONFIGURA√á√ÉO DO JAEGER AGENT:
# =============================================================================
# 1. Editar docker-compose-app.yml
# 2. Substituir JAEGER_COLLECTOR_IP pelo IP real da Inst√¢ncia 1
# 3. Reiniciar: docker-compose -f docker-compose-app.yml restart jaeger-agent
# =============================================================================