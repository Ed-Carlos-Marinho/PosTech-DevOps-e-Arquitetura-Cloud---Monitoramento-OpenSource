# =============================================================================
# PROMTAIL VALUES
# =============================================================================
# Aula 07 - PosTech DevOps - Observabilidade no Kubernetes
# Configuração para Promtail (Coleta de Logs)
# =============================================================================

# =============================================================================
# PROMTAIL CONFIGURATION
# =============================================================================
config:
  # Configuração do servidor
  server:
    http_listen_port: 3101
    grpc_listen_port: 0
  
  # Configuração de posições
  positions:
    filename: /tmp/positions.yaml
  
  # Configuração de clientes (conexão com Loki)
  clients:
    - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push
      tenant_id: 1
  
  # Configuração de scraping
  scrape_configs:
    # Logs de containers via Kubernetes API
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        # Extrair namespace
        - source_labels:
            - __meta_kubernetes_namespace
          target_label: namespace
        
        # Extrair nome do pod
        - source_labels:
            - __meta_kubernetes_pod_name
          target_label: pod
        
        # Extrair nome do container
        - source_labels:
            - __meta_kubernetes_pod_container_name
          target_label: container
        
        # Extrair nome da aplicação
        - source_labels:
            - __meta_kubernetes_pod_label_app
          target_label: app
        
        # Configurar path dos logs
        - source_labels:
            - __meta_kubernetes_pod_uid
            - __meta_kubernetes_pod_container_name
          target_label: __path__
          separator: /
          replacement: /var/log/pods/*$1/*.log
      
      # Pipeline de processamento de logs
      pipeline_stages:
        # Parse do formato de log do Kubernetes
        - cri: {}

# =============================================================================
# DEPLOYMENT CONFIGURATION
# =============================================================================
# Recursos computacionais reduzidos
resources:
  requests:
    memory: 64Mi
    cpu: 25m
  limits:
    memory: 128Mi
    cpu: 50m

# =============================================================================
# VOLUME CONFIGURATION
# =============================================================================
# Configurações de volume para acessar logs dos pods
volumeMounts:
  - name: pods
    mountPath: /var/log/pods
    readOnly: true
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true

volumes:
  - name: pods
    hostPath:
      path: /var/log/pods
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
# Configurações de segurança
securityContext:
  runAsUser: 0
  privileged: true

# =============================================================================
# SCHEDULING CONFIGURATION
# =============================================================================
# Tolerations para executar em todos os nodes
tolerations:
  - effect: NoSchedule
    operator: Exists
  - effect: NoExecute
    operator: Exists

# Node selector (executar em todos os nodes)
nodeSelector: {}

# =============================================================================
# SERVICE ACCOUNT CONFIGURATION
# =============================================================================
serviceAccount:
  create: true

# =============================================================================
# ADDITIONAL CONFIGURATIONS
# =============================================================================

# Labels comuns
commonLabels:
  app.kubernetes.io/part-of: observability-stack
  course: postech-devops
  class: aula-07