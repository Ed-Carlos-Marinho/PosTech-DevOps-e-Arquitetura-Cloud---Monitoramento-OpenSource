# =============================================================================
# INGRESS NGINX VALUES
# =============================================================================
# Aula 07 - PosTech DevOps - Observabilidade no Kubernetes
# Configuração para ingress-nginx (Ingress Controller)
# =============================================================================

# =============================================================================
# CONTROLLER CONFIGURATION
# =============================================================================
controller:
  # Imagem do controller
  image:
    registry: registry.k8s.io
    image: ingress-nginx/controller
    tag: "v1.8.1"
    digest: ""
    pullPolicy: IfNotPresent
  
  # Recursos computacionais
  resources:
    requests:
      cpu: 100m
      memory: 90Mi
    limits:
      cpu: 200m
      memory: 256Mi
  
  # Configurações de autoscaling
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 11
    targetCPUUtilizationPercentage: 50
    targetMemoryUtilizationPercentage: 50
  
  # Número de réplicas (se autoscaling desabilitado)
  replicaCount: 2
  
  # Service configuration
  service:
    enabled: true
    type: LoadBalancer
    
    # Annotations para AWS Application Load Balancer
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-type: "external"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/healthz"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-port: "10254"
      service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "http"
    
    # Portas do serviço
    ports:
      http: 80
      https: 443
    
    targetPorts:
      http: http
      https: https
    
    # External Traffic Policy
    externalTrafficPolicy: Local
  
  # Configurações de métricas
  metrics:
    enabled: true
    port: 10254
    
    # ServiceMonitor para Prometheus (será habilitado após instalar kube-prometheus-stack)
    serviceMonitor:
      enabled: false
      additionalLabels:
        app.kubernetes.io/part-of: observability-stack
      namespace: monitoring
      namespaceSelector: {}
      scrapeInterval: 30s
      targetLabels: []
      relabelings: []
      metricRelabelings: []
  
  # Configurações de logs
  config:
    # Formato de logs
    log-format-escape-json: "true"
    log-format-upstream: '{"time": "$time_iso8601", "remote_addr": "$proxy_protocol_addr", "x_forwarded_for": "$proxy_add_x_forwarded_for", "request_id": "$req_id", "remote_user": "$remote_user", "bytes_sent": $bytes_sent, "request_time": $request_time, "status": $status, "vhost": "$host", "request_proto": "$server_protocol", "path": "$uri", "request_query": "$args", "request_length": $request_length, "duration": $request_time,"method": "$request_method", "http_referrer": "$http_referer", "http_user_agent": "$http_user_agent"}'
    
    # Configurações de proxy
    proxy-connect-timeout: "15"
    proxy-send-timeout: "600"
    proxy-read-timeout: "600"
    proxy-body-size: "64m"
    
    # Configurações de SSL
    ssl-protocols: "TLSv1.2 TLSv1.3"
    ssl-ciphers: "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384"
    
    # Configurações de rate limiting
    rate-limit-rps: "100"
    
    # Habilitar snippets (cuidado em produção)
    allow-snippet-annotations: "false"
  
  # Configurações de admissão
  admissionWebhooks:
    enabled: true
    patch:
      enabled: true
      image:
        registry: registry.k8s.io
        image: ingress-nginx/kube-webhook-certgen
        tag: v20220916-gd32f8c343
        pullPolicy: IfNotPresent
  
  # Configurações de segurança
  securityContext:
    capabilities:
      drop:
        - ALL
      add:
        - NET_BIND_SERVICE
    runAsUser: 101
    allowPrivilegeEscalation: true
  
  # Node selector e tolerations
  nodeSelector:
    kubernetes.io/os: linux
  
  tolerations: []
  
  affinity: {}
  
  # Configurações de pod disruption budget
  podDisruptionBudget:
    enabled: false
    minAvailable: 1

# =============================================================================
# DEFAULT BACKEND CONFIGURATION
# =============================================================================
defaultBackend:
  enabled: false

# =============================================================================
# RBAC CONFIGURATION
# =============================================================================
rbac:
  create: true
  scope: false

# =============================================================================
# SERVICE ACCOUNT CONFIGURATION
# =============================================================================
serviceAccount:
  create: true
  name: ""
  automountServiceAccountToken: true
  annotations: {}

# =============================================================================
# POD SECURITY POLICY (DEPRECATED)
# =============================================================================
podSecurityPolicy:
  enabled: false

# =============================================================================
# ADDITIONAL CONFIGURATIONS
# =============================================================================

# Configurações de namespace
namespaceOverride: ""

# Labels comuns
commonLabels:
  app.kubernetes.io/part-of: observability-stack
  course: postech-devops
  class: aula-07

# Annotations comuns
commonAnnotations: {}

# Configurações de imagem
imagePullSecrets: []

# Configurações de TCP/UDP services (se necessário)
tcp: {}
udp: {}

# Configurações de DH parameters
dhParam: ""