# =============================================================================
# LOKI CONFIGURATION - AULA 04
# =============================================================================
# Configuração do Loki para coleta e armazenamento de logs centralizados
# Aula 04 - PosTech DevOps e Arquitetura Cloud - Monitoramento OpenSource
# Foco: Logs centralizados com integração ao Grafana
# =============================================================================

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DO SERVIDOR
# -----------------------------------------------------------------------------
server:
  http_listen_port: 3100                    # Porta HTTP para API e interface
  grpc_listen_port: 9096                    # Porta gRPC para comunicação interna
  log_level: info                           # Nível de log (debug, info, warn, error)

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE AUTENTICAÇÃO (Desabilitada para ambiente de desenvolvimento)
# -----------------------------------------------------------------------------
auth_enabled: false                         # Desabilita autenticação (HABILITAR EM PRODUÇÃO)

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DO INGESTER (Componente que recebe e processa logs)
# -----------------------------------------------------------------------------
ingester:
  # Configurações do ciclo de vida dos chunks
  lifecycler:
    address: 127.0.0.1                      # Endereço do ingester
    ring:
      kvstore:
        store: inmemory                     # Armazenamento em memória (para desenvolvimento)
      replication_factor: 1                 # Fator de replicação (1 para single instance)
    final_sleep: 0s                         # Tempo de espera antes de finalizar
  
  # Configurações de chunks (blocos de dados de log)
  chunk_idle_period: 1h                     # Tempo antes de considerar chunk inativo
  max_chunk_age: 1h                         # Idade máxima de um chunk
  chunk_target_size: 1048576                # Tamanho alvo do chunk (1MB)
  chunk_retain_period: 30s                  # Tempo de retenção do chunk na memória
  max_transfer_retries: 0                   # Tentativas de transferência (0 = sem limite)

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DO SCHEMA (Estrutura de armazenamento)
# -----------------------------------------------------------------------------
schema_config:
  configs:
    - from: 2020-10-24                      # Data de início do schema
      store: boltdb-shipper                 # Tipo de armazenamento de índice
      object_store: filesystem              # Tipo de armazenamento de objetos
      schema: v11                           # Versão do schema
      index:
        prefix: index_                      # Prefixo dos arquivos de índice
        period: 24h                         # Período de rotação do índice

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE ARMAZENAMENTO
# -----------------------------------------------------------------------------
storage_config:
  # Configurações do BoltDB Shipper (armazenamento de índices)
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active    # Diretório de índices ativos
    cache_location: /loki/boltdb-shipper-cache             # Cache dos índices
    cache_ttl: 24h                                         # TTL do cache
    shared_store: filesystem                               # Armazenamento compartilhado
  
  # Configurações do sistema de arquivos (armazenamento de chunks)
  filesystem:
    directory: /loki/chunks                 # Diretório para armazenar chunks de logs

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE COMPACTAÇÃO (Otimização de armazenamento)
# -----------------------------------------------------------------------------
compactor:
  working_directory: /loki/boltdb-shipper-compactor  # Diretório de trabalho do compactador
  shared_store: filesystem                            # Armazenamento compartilhado
  compaction_interval: 10m                           # Intervalo de compactação

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE LIMITES (Prevenção de sobrecarga)
# -----------------------------------------------------------------------------
limits_config:
  # Limites de ingestão
  ingestion_rate_mb: 4                      # Taxa máxima de ingestão (4MB/s)
  ingestion_burst_size_mb: 6                # Tamanho máximo de burst (6MB)
  
  # Limites de consulta
  max_query_parallelism: 32                 # Paralelismo máximo de consultas
  max_query_series: 500                     # Máximo de séries por consulta
  max_query_length: 721h                    # Duração máxima de consulta (30 dias)
  
  # Limites de labels
  max_streams_per_user: 10000               # Máximo de streams por usuário
  max_line_size: 256000                     # Tamanho máximo de linha (256KB)
  
  # Configurações de retenção
  retention_period: 744h                    # Período de retenção (31 dias)

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE CHUNK STORE (Armazenamento de chunks)
# -----------------------------------------------------------------------------
chunk_store_config:
  max_look_back_period: 0s                  # Período máximo de busca retroativa

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE TABLE MANAGER (Gerenciamento de tabelas)
# -----------------------------------------------------------------------------
table_manager:
  retention_deletes_enabled: false          # Habilita deleção por retenção
  retention_period: 0s                      # Período de retenção (0 = desabilitado)

# -----------------------------------------------------------------------------
# CONFIGURAÇÕES DE RULER (Regras de alerta baseadas em logs)
# -----------------------------------------------------------------------------
ruler:
  storage:
    type: local                             # Tipo de armazenamento para regras
    local:
      directory: /loki/rules                # Diretório das regras
  rule_path: /loki/rules                    # Caminho das regras
  # alertmanager_url: http://alertmanager:9093  # URL do Alertmanager (desabilitado para Aula 04)
  ring:
    kvstore:
      store: inmemory                       # Armazenamento em memória
  enable_api: true                          # Habilita API do ruler

# =============================================================================
# INTEGRAÇÃO COM GRAFANA - AULA 04:
# =============================================================================
# 1. Este Loki será configurado como Data Source no Grafana
# 2. URL do Data Source: http://loki:3100
# 3. Dashboards recomendados para importar:
#    - Loki Stack Monitoring (ID: 14055)
#    - Promtail (ID: 15141)
#    - Logs App (built-in do Grafana)
#
# 4. Consultas LogQL básicas para começar:
#    - {job="varlogs"}: Todos os logs do job varlogs
#    - {filename="/var/log/syslog"}: Logs específicos do syslog
#    - {job="varlogs"} |= "error": Logs contendo "error"
#    - rate({job="varlogs"}[5m]): Taxa de logs por segundo
# =============================================================================
#
# EXPLICAÇÃO DOS COMPONENTES:
# =============================================================================
# 1. INGESTER: Recebe logs do Promtail e os organiza em chunks
# 2. DISTRIBUTOR: Distribui logs entre ingesters (não usado em single instance)
# 3. QUERIER: Processa consultas LogQL e retorna resultados
# 4. QUERY FRONTEND: Cache e otimização de consultas (não usado aqui)
# 5. COMPACTOR: Compacta e otimiza dados antigos
# 6. RULER: Processa regras de alerta baseadas em logs
# =============================================================================
#
# OTIMIZAÇÕES PARA PRODUÇÃO:
# =============================================================================
# 1. Habilitar auth_enabled: true
# 2. Usar armazenamento distribuído (S3, GCS, etc.)
# 3. Configurar múltiplos ingesters para alta disponibilidade
# 4. Ajustar limites conforme volume de logs
# 5. Configurar retenção adequada para compliance
# 6. Implementar backup dos dados
# 7. Monitorar métricas do próprio Loki
# =============================================================================